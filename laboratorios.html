<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n de Laboratorios UNAJMA - 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --blue: #1a3a5a; --bg: #f4f7f9; --red: #e53e3e; --green: #38a169; --purple: #8e44ad; --orange: #d35400; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        nav { background: var(--blue); padding: 12px; text-align: center; flex-shrink: 0; }
        nav a { color: white; margin: 0 15px; text-decoration: none; font-weight: bold; font-size: 13px; }

        .layout { display: flex; flex-grow: 1; overflow: hidden; width: 100vw; position: relative; }
        .sidebar { width: 350px; background: white; border-right: 2px solid #ddd; padding: 15px; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; }
        .main-content { flex-grow: 1; padding: 20px; overflow: auto; background: var(--bg); position: relative; }
        
        .schedule-table { width: 100%; min-width: 950px; border-collapse: collapse; background: white; border: 2px solid #000; table-layout: fixed; }
        .schedule-table th { background: var(--blue); color: white; padding: 10px; border: 1px solid #000; font-size: 11px; position: sticky; top: 0; z-index: 10; }
        .schedule-table td { border: 1px solid #000; height: 180px; text-align: center; vertical-align: middle; padding: 5px; position: relative; }
        
        .hour-cell { background: #edf2f7; font-weight: bold; width: 90px; font-size: 11px; }
        .course-block { border: 1px solid #ddd; border-radius: 6px; padding: 8px; margin-bottom: 5px; background: #fff; text-align: left; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .course-block.drag-over { border: 2px dashed var(--purple); background: #f3e8ff; }
        .course-title { font-weight: bold; font-size: 9px; color: var(--blue); display: block; border-bottom: 1px solid #eee; margin-bottom: 3px; }
        
        .lab-asignado { background: var(--purple); color: white; padding: 4px 6px; border-radius: 4px; font-size: 10px; margin-top: 4px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
        .btn-del-asig { background: none; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 12px; }

        .aforo-badge { font-size: 9px; font-weight: bold; margin-top: 4px; padding: 2px 5px; border-radius: 3px; display: block; text-align: center; box-sizing: border-box; }
        .exceso { background: #fff5f5; color: var(--red); border: 1px solid var(--red); }
        .sobra { background: #f0fff4; color: var(--green); border: 1px solid var(--green); }

        .input-sidebar { padding: 10px; margin-bottom: 8px; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        .btn-action { background: var(--blue); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 10px; font-size: 12px; }
        .lab-item-sidebar { background: var(--purple); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 11px; border-left: 6px solid #4b0082; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
    </style>
</head>
<body>

<nav>
     <a href="horarios.html">Horarios</a>    
    <a href="vista_docente.html">Horario Docente</a>
    <a href="laboratorios.html">Asignar Laboratorios</a>
    <a href="vista_laboratorios.html">Vista Ocupaci√≥n</a>
</nav>

<div class="layout">
    <div class="sidebar">
        <h3>üß™ Gesti√≥n de Laboratorios</h3>
        <input type="text" id="labNom" class="input-sidebar" placeholder="Nombre (ej: Lab 07)">
        <input type="number" id="labCap" class="input-sidebar" placeholder="Capacidad de PCs">
        <button class="btn-action" onclick="agregarLab()">+ REGISTRAR LABORATORIO</button>
        
        <hr style="width: 100%; border: 0.5px solid #eee; margin: 15px 0;">
        <div id="listaLabs" style="flex-grow:1; overflow-y:auto;"></div>
        
        <button class="btn-action" style="background:var(--purple);" onclick="optimizarBloquesContinuos()">ü§ñ OPTIMIZACI√ìN POR BLOQUES</button>
        <button class="btn-action" style="background:var(--red);" onclick="limpiarAsignaciones()">üóëÔ∏è LIMPIAR TODO</button>
        <button class="btn-action" style="background:var(--green);" onclick="guardarAsignaciones()">üíæ GUARDAR CAMBIOS</button>
    </div>

    <div class="main-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0; color:var(--blue);">PLANIFICACI√ìN T√âCNICA Y TURNOS</h2>
            <select id="selCiclo" onchange="renderHorarioConCursos()" style="padding:10px; font-weight:bold; border-radius:8px; border: 2px solid var(--blue);">
                <option value="I">Ciclo I</option><option value="II">Ciclo II</option><option value="III">Ciclo III</option>
                <option value="IV">Ciclo IV</option><option value="V">Ciclo V</option><option value="VI">Ciclo VI</option>
                <option value="VII">Ciclo VII</option><option value="VIII">Ciclo VIII</option><option value="IX">Ciclo IX</option>
                <option value="X">Ciclo X</option>
            </select>
        </div>
        <table class="schedule-table">
            <thead>
                <tr><th>HORA</th><th>LUNES</th><th>MARTES</th><th>MIERCOLES</th><th>JUEVES</th><th>VIERNES</th></tr>
            </thead>
            <tbody id="cuerpoLab"></tbody>
        </table>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyBNjlmtZJXtsmW7qKBUKVBZItG1jWilBEc", 
        authDomain: "carga-docente.firebaseapp.com", 
        projectId: "carga-docente", 
        storageBucket: "carga-docente.firebasestorage.app", 
        messagingSenderId: "994250556754", 
        appId: "1:994250556754:web:ecabed4715e7803542e68b" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let laboratorios = [], horariosData = {}, censoSincronizado = {};
    const horas = ["07:00-08:00", "08:00-09:00", "09:00-10:00", "10:00-11:00", "11:00-12:00", "12:00-13:00", "14:00-15:00", "15:00-16:00", "16:00-17:00", "17:00-18:00", "18:00-19:00", "19:00-20:00"];
    const ciclos = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];

    window.onload = async () => {
        const hor = await db.collection("planificacion").doc("horarios").get();
        if(hor.exists) horariosData = hor.data().horariosGeneral || {};
        const labs = await db.collection("planificacion").doc("config_laboratorios").get();
        if(labs.exists) laboratorios = labs.data().lista || [];
        const config = await db.collection("planificacion").doc("config_general").get();
        if(config.exists) censoSincronizado = config.data().censoCursos || {};
        
        renderListaLabs(); renderHorarioConCursos();
    };

    // --- DETECCI√ìN DE CURSO DIVIDIDO O COMPLETO ---
    function obtenerDemandaReal(codigoCurso) {
        let docentes = new Set();
        ciclos.forEach(c => {
            const data = horariosData[c] || {};
            Object.values(data).forEach(bloque => {
                bloque.forEach(ins => { if(ins.codigo === codigoCurso && ins.subTipo === "HP") docentes.add(ins.docente); });
            });
        });
        const totalAlumnos = censoSincronizado[codigoCurso]?.total || 0;
        // Si hay m√°s de 1 docente, se asume divisi√≥n al 50%. Si es docente √∫nico, 100%.
        return docentes.size > 1 ? Math.ceil(totalAlumnos / 2) : totalAlumnos;
    }

    // --- DRAG & DROP ---
    function onDragStart(ev, labNombre) { ev.dataTransfer.setData("text", labNombre); }
    function onDragOver(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
    function onDragLeave(ev) { ev.currentTarget.classList.remove('drag-over'); }
    function onDrop(ev, key, idx) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('drag-over');
        const labNom = ev.dataTransfer.getData("text");
        const cic = document.getElementById('selCiclo').value;
        const hayCruce = ciclos.some(c => (horariosData[c]?.[key] || []).some(b => b.lab === labNom));
        if(hayCruce) return alert("üö´ Laboratorio ocupado.");
        horariosData[cic][key][idx].lab = labNom;
        renderHorarioConCursos();
    }

    // --- OPTIMIZACI√ìN POR BLOQUE CONTINUO ---
    async function optimizarBloquesContinuos() {
        if(!confirm("ü§ñ Optimizando... Se respetar√° el mismo lab para horas seguidas del docente.")) return;
        ciclos.forEach(c => { if(horariosData[c]) Object.keys(horariosData[c]).forEach(k => { horariosData[c][k].forEach(b => b.lab = ""); }); });
        const labsDesc = [...laboratorios].sort((a, b) => b.capacidad - a.capacidad);

        for (let d = 1; d <= 5; d++) {
            for (let i = 0; i < horas.length; i++) {
                const key = `${i}-${d}`;
                let reqs = [];
                ciclos.forEach(cic => {
                    (horariosData[cic]?.[key] || []).forEach((inst, idx) => {
                        if (inst.subTipo === "HP" && !inst.lab) {
                            let bloqueH = [i];
                            for(let hProx = i + 1; hProx < horas.length; hProx++) {
                                const sig = (horariosData[cic]?.[`${hProx}-${d}`] || []).find(p => p.docente === inst.docente && p.codigo === inst.codigo);
                                if(sig) bloqueH.push(hProx); else break;
                            }
                            reqs.push({ cic, key, idx, demanda: obtenerDemandaReal(inst.codigo), docente: inst.docente, codigo: inst.codigo, bloqueH });
                        }
                    });
                });
                reqs.sort((a, b) => b.demanda - a.demanda);
                reqs.forEach(r => {
                    const lab = labsDesc.find(l => r.bloqueH.every(h => !ciclos.some(c => (horariosData[c]?.[`${h}-${d}`] || []).some(b => b.lab === l.nombre))));
                    if (lab) {
                        r.bloqueH.forEach(h => {
                            const target = (horariosData[r.cic][`${h}-${d}`]).find(b => b.docente === r.docente && b.codigo === r.codigo);
                            if(target) target.lab = lab.nombre;
                        });
                    }
                });
            }
        }
        renderHorarioConCursos();
    }

    function renderHorarioConCursos() {
        const cic = document.getElementById('selCiclo').value;
        const cuerpo = document.getElementById('cuerpoLab');
        const dataCiclo = horariosData[cic] || {};
        cuerpo.innerHTML = "";
        horas.forEach((h, i) => {
            if(i === 6) cuerpo.innerHTML += `<tr><td colspan="6" style="background:#cbd5e0; height:10px; font-size:8px; text-align:center;">RECESO</td></tr>`;
            let row = `<tr><td class="hour-cell">${h}</td>`;
            for(let d=1; d<=5; d++) {
                const key = `${i}-${d}`;
                const bloques = dataCiclo[key] || [];
                row += `<td>`;
                bloques.forEach((inf, idx) => {
                    const demanda = obtenerDemandaReal(inf.codigo);
                    const lab = laboratorios.find(l => l.nombre === inf.lab);
                    const dif = lab ? lab.capacidad - demanda : 0;
                    row += `<div class="course-block" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, '${key}', ${idx})">
                        <span class="course-title">${inf.curso}</span>
                        <span style="font-size:8px; color:#666;">üë§ ${inf.docente} | Demanda: ${demanda}</span>
                        ${inf.subTipo === "HP" ? `
                            ${inf.lab ? `
                                <div class="lab-asignado">üìç ${inf.lab} <button class="btn-del-asig" onclick="quitarAsignacion('${key}', ${idx})">‚úï</button></div>
                                <div class="aforo-badge ${dif < 0 ? 'exceso':'sobra'}">${dif < 0 ? '‚ùå Falta':'‚úÖ Sobra'} ${Math.abs(dif)} PCs</div>
                            ` : '<span style="color:var(--orange); font-size:8.5px; font-weight:bold;">‚ö†Ô∏è Arrastre Lab</span>'}
                        ` : '<span style="color:#999; font-size:8px;">Teor√≠a</span>'}
                    </div>`;
                });
                row += `</td>`;
            }
            cuerpo.innerHTML += row + `</tr>`;
        });
    }

    function agregarLab() {
        const n = document.getElementById('labNom').value, c = document.getElementById('labCap').value;
        if(!n || !c) return alert("Faltan datos");
        laboratorios.push({ id: Date.now(), nombre: n.toUpperCase(), capacidad: parseInt(c) });
        renderListaLabs();
        document.getElementById('labNom').value = ""; document.getElementById('labCap').value = "";
    }

    function renderListaLabs() {
        const cont = document.getElementById('listaLabs');
        cont.innerHTML = laboratorios.map(l => `<div class="lab-item-sidebar" draggable="true" ondragstart="onDragStart(event, '${l.nombre}')"><strong>${l.nombre}</strong> <span>${l.capacidad} PCs</span><button onclick="borrarLab(${l.id})" style="background:none; border:none; color:white; cursor:pointer;">üóëÔ∏è</button></div>`).join("");
    }

    function borrarLab(id) { if(confirm("¬øEliminar?")) { laboratorios = laboratorios.filter(l => l.id !== id); renderListaLabs(); } }
    function quitarAsignacion(key, idx) { horariosData[document.getElementById('selCiclo').value][key][idx].lab = ""; renderHorarioConCursos(); }
    function limpiarAsignaciones() { if(confirm("¬øLimpiar?")) { ciclos.forEach(c => { if(horariosData[c]) Object.keys(horariosData[c]).forEach(k => { horariosData[c][k].forEach(b => b.lab = ""); }); }); renderHorarioConCursos(); } }
    async function guardarAsignaciones() {
        await db.collection("planificacion").doc("config_laboratorios").set({ lista: laboratorios });
        await db.collection("planificacion").doc("horarios").set({ horariosGeneral: horariosData, ultimaActualizacion: new Date() });
        alert("‚úÖ Sincronizado.");
    }
</script>
</body>
</html>